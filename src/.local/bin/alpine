#!/usr/bin/env bash

DNS="8.8.8.8"
IMG="$HOME/vm/virt/alpine/alpine.img"
VOLUME="$HOME/vm/volume"

# [host]=guest
PORTS=(
    [2222]=22
    [9443]=9443
    [8080]=8080
    [8081]=8081
)

HOSTFWD=""

for HPORT in "${!PORTS[@]}"; do
    GPORT="${PORTS[HPORT]}"
    HOSTFWD+="hostfwd=tcp::${HPORT}-:${GPORT},"
done

# Generate host & run VM
HOSTFWD="${HOSTFWD%,}"

qemu-system-x86_64 -machine q35 \
    -m 1024 -smp cpus=2 -cpu qemu64 \
    -drive if=pflash,format=raw,read-only=on,file=$PREFIX/share/qemu/edk2-x86_64-code.fd \
    -netdev user,id=n1,dns=$DNS,$HOSTFWD \
    -device virtio-net,netdev=n1 \
    -fsdev local,id=fsdev0,path=$VOLUME,security_model=none \
    -device virtio-9p-pci,fsdev=fsdev0,mount_tag=hostshare \
    -nographic "$IMG"
